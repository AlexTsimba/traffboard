# Environment Variables Management Guide

## Overview
This document explains how to properly handle environment variables across different environments: Local Development, GitHub Actions CI/CD, and DigitalOcean App Platform.

## üîí Security Principles

### ‚ùå NEVER DO:
- Hardcode secrets in code
- Commit `.env` files with real secrets to git
- Use `SKIP_ENV_VALIDATION: true` in production
- Share production secrets across environments
- Put real database URLs in CI

### ‚úÖ ALWAYS DO:
- Use environment-specific configurations
- Encrypt secrets at rest
- Use proper secret management systems
- Validate environment variables
- Use minimal required permissions

## üè† Local Development

### Files:
- `.env.local` - Your personal local secrets (gitignored)
- `.env.example` - Template showing required variables (committed)

### Setup:
```bash
# Copy example and fill with local values
cp .env.example .env.local

# Your .env.local should contain:
DATABASE_URL="postgresql://postgres:password@localhost:5432/traffboard_dev"
BETTER_AUTH_SECRET="local-dev-secret-key-not-for-production"
BETTER_AUTH_URL="http://localhost:3000"
NEXT_PUBLIC_BETTER_AUTH_URL="http://localhost:3000"
```

## ü§ñ GitHub Actions CI

### Purpose: 
Test code without real production data

### Configuration:
```yaml
# No real secrets needed for testing
jobs:
  test:
    steps:
    - name: Run TypeScript check
      run: npx tsc --noEmit
      # No env vars needed for type checking
    
    - name: Run tests  
      run: npm test
      # Tests should use test fixtures, not real DB
```

### Secrets Management:
- Only store `DIGITALOCEAN_ACCESS_TOKEN` in GitHub Secrets
- Never store production database URLs or auth secrets
- Use GitHub's encrypted secrets for deployment tokens only

## üåä DigitalOcean App Platform

### Purpose:
Production environment with real secrets

### Configuration Methods:

#### 1. Via App Spec (`app.yaml`):
```yaml
envs:
  - key: DATABASE_URL
    value: "${traffboard-db.DATABASE_URL}"  # Auto-generated by DO
    scope: RUN_AND_BUILD_TIME
  - key: BETTER_AUTH_SECRET
    scope: RUN_AND_BUILD_TIME
    type: SECRET  # This makes it encrypted
  - key: BETTER_AUTH_URL
    value: "https://traffboard-7gwxh.ondigitalocean.app"
    scope: RUN_AND_BUILD_TIME
```

#### 2. Via DigitalOcean Console:
- Go to App Platform ‚Üí Your App ‚Üí Settings ‚Üí App-Level Environment Variables
- Add variables with "Encrypt" checkbox for secrets
- DigitalOcean encrypts and stores them securely

### Best Practices:
- Use `type: SECRET` for sensitive values
- Use `${service-name.VARIABLE}` for service references
- Scope variables appropriately (`RUN_TIME`, `BUILD_TIME`, `RUN_AND_BUILD_TIME`)

## üîÑ Environment Flow

```
Local Dev     ‚Üí  GitHub CI    ‚Üí  DigitalOcean
‚îú‚îÄ .env.local    ‚îú‚îÄ No secrets    ‚îú‚îÄ Encrypted secrets
‚îú‚îÄ Real DB       ‚îú‚îÄ Type check    ‚îú‚îÄ Production DB  
‚îî‚îÄ Dev secrets   ‚îî‚îÄ Tests only    ‚îî‚îÄ Real auth
```

## üìã Variable Types by Environment

| Variable | Local | GitHub CI | DigitalOcean |
|----------|-------|-----------|--------------|
| `DATABASE_URL` | Local PostgreSQL | Not needed | `${traffboard-db.DATABASE_URL}` |
| `BETTER_AUTH_SECRET` | Dev secret | Not needed | Encrypted secret |
| `BETTER_AUTH_URL` | `localhost:3000` | Not needed | Production URL |
| `DIGITALOCEAN_ACCESS_TOKEN` | Not needed | GitHub Secret | Not needed |

## üõ°Ô∏è Security Checklist

- [ ] `.env.local` is in `.gitignore`
- [ ] `.env.example` shows required variables (no real values)
- [ ] GitHub Actions only has deployment token
- [ ] DigitalOcean secrets are encrypted (`type: SECRET`)
- [ ] No hardcoded secrets in code
- [ ] Environment validation is enabled in production
- [ ] Minimal permissions on all tokens

## üö® Common Mistakes

1. **Using `SKIP_ENV_VALIDATION: true` everywhere**
   - Only use during build when env vars aren't needed
   - Never skip validation in runtime

2. **Sharing secrets across environments**
   - Each environment should have its own secrets
   - Production secrets should never be in CI

3. **Putting real DB URLs in CI**
   - CI should test logic, not databases
   - Use mocks/fixtures for testing

4. **Not using proper secret types**
   - Always use `type: SECRET` for sensitive data in DigitalOcean
   - Use GitHub Secrets for CI tokens

## üîß Troubleshooting

### "Environment variable not found"
- Check variable name spelling
- Verify scope (`RUN_TIME` vs `BUILD_TIME`)
- Ensure variable is set in correct environment

### "Database connection failed"
- Verify `DATABASE_URL` format
- Check if database service is running
- Confirm network connectivity

### "Build failing with env validation"
- Use `SKIP_ENV_VALIDATION: true` only for build steps that don't need runtime vars
- Never skip validation for the actual application runtime

## üìö References

- [DigitalOcean Environment Variables](https://docs.digitalocean.com/products/app-platform/how-to/use-environment-variables/)
- [GitHub Actions Secrets](https://docs.github.com/en/actions/security-guides/encrypted-secrets)
- [Next.js Environment Variables](https://nextjs.org/docs/basic-features/environment-variables)