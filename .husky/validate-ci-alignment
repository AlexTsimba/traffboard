#!/bin/sh

# CI/CD Alignment Validator - Research-backed implementation
# Based on Husky best practices and 2024 CI/CD patterns
# Sources: Context7 /typicode/husky docs + web research

echo "ğŸ” Validating CI/CD alignment..."

# Performance optimization: Skip environment validation during alignment check
export SKIP_ENV_VALIDATION=true

# Build validation (matches CI exactly)
echo "ğŸ—ï¸  Build check..."
if ! npm run build >/dev/null 2>&1; then
  echo "âŒ Build errors found - CI will fail"
  echo "ğŸ’¡ Run 'npm run build' to see detailed errors"
  exit 1
fi

# TypeScript compilation (matches CI exactly)
echo "ğŸ“ TypeScript check..."
if ! npx tsc --noEmit --pretty; then
  echo "âŒ TypeScript errors found - CI will fail"
  exit 1
fi

# Linting (matches CI exactly)
echo "ğŸ”§ ESLint check..."
if ! npm run lint; then
  echo "âŒ Linting errors found - CI will fail"  
  exit 1
fi

# Format validation (matches CI expectations)
echo "ğŸ’… Format check..."
if ! npm run format:check >/dev/null 2>&1; then
  echo "âŒ Formatting issues found - run 'npm run format:write'"
  exit 1
fi

# Test validation (if tests exist, validate they can run)
if [ -f "playwright.config.ts" ]; then
  echo "ğŸ§ª Test environment validation..."
  # Check if Playwright browsers are installed
  if ! npx playwright install --dry-run >/dev/null 2>&1; then
    echo "âš ï¸  Playwright browsers may need installation: npx playwright install"
  fi
  
  # Validate test setup doesn't have critical errors
  if ! npm run test:setup >/dev/null 2>&1; then
    echo "âš ï¸  Test setup may have issues - check database configuration"
  fi
fi

# Dependency validation (matches CI lockfile check)
echo "ğŸ“¦ Dependency validation..."
if [ -f "package-lock.json" ]; then
  if ! npm ci --dry-run >/dev/null 2>&1; then
    echo "âŒ Package lock file issues - CI will fail"
    echo "ğŸ’¡ Run 'npm install' to fix lockfile"
    exit 1
  fi
fi

echo "âœ… Local setup fully aligned with CI/CD pipeline"
echo "ğŸš€ Ready for production deployment"